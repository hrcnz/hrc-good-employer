
$(function(){var k="1tqmFWhHqsCQ7-OjwHaDxW66xJ_3R8hTbF3PqTCEikbg";var d="https://docs.google.com/spreadsheet/pub?hl=en_US&hl=en_US&key="+k+"&output=html";var i="http://hrcnz.github.io/hrc-good-employer";var j="https://cegebuffer.s3.amazonaws.com";var b={};var o={};var m={};var e={};var l={white:{r:255,g:255,b:255},dark:{r:97,g:97,b:97},medium:{r:160,g:160,b:160},light:{r:210,g:210,b:210},lighter:{r:237,g:237,b:237},all:{r:115,g:28,b:31},all_light:{r:210,g:164,b:166},entity:{r:36,g:173,b:162},entity_light:{r:203,g:227,b:225},type:{r:163,g:185,b:64},type_light:{r:220,g:227,b:179},size:{r:36,g:98,b:132},size_light:{r:185,g:195,b:212}};var h="978-0-478-35664-9";b.Control=Backbone.Model.extend({color:function(s,p){s=typeof s!=="undefined"?s:false;p=typeof p!=="undefined"?p:false;var q=this.get("report");var r;if(q==="all"){r=s?l.all_light:l.all}else{if(q==="entity"){r=s?l.entity_light:l.entity}else{if(q==="type"){r=s?l.type_light:l.type}else{if(q==="size"){r=s?l.size_light:l.size}}}}return p?g(r):r},accordionCloseAll:function(){$(".accordion").removeClass("open");$(".accordion-bottom").slideUp();$(".accordion-top").attr("aria-expanded",false);$(".accordion-top").attr("aria-selected",false);$(".accordion-bottom").attr("aria-expanded",false);$(".accordion-bottom").attr("aria-hidden",true);$("a.accordion-open").attr("aria-hidden",false);$("a.accordion-false").attr("aria-hidden",true)},renderPdf:function(){$.getJSON("data/pdfimagedata.json",function(p){e.docWriter=new b.DocWriter({images:p});e.viewsIntro.renderPdf(e.docWriter);e.viewsOverview.renderPdf(e.docWriter);e.docWriter.addText("1/2","page_no");e.viewsDetails.renderPdf(e.docWriter);e.docWriter.addText("2/2","page_no");e.viewsFooter.renderPdf(e.docWriter);e.docWriter.output()})}});b.Year=Backbone.Model.extend({initialize:function(){this.set("summaryoverview",this.get("summaryoverview").replace(/[^\u0000-\u007E]/g," ").replace("  "," "));this.set("summarygeref",this.get("summarygeref").replace(/[^\u0000-\u007E]/g," ").replace("  "," "));this.set("summaryeeoref",this.get("summaryeeoref").replace(/[^\u0000-\u007E]/g," ").replace("  "," "));this.set("summarygeelements",this.get("summarygeelements").replace(/[^\u0000-\u007E]/g," ").replace("  "," "));this.set("summaryreview",this.get("summaryreview").replace(/[^\u0000-\u007E]/g," ").replace("  "," "));this.set("summarywp",this.get("summarywp").replace(/[^\u0000-\u007E]/g," ").replace("  "," "));this.set("summaryparticipation",this.get("summaryparticipation").replace(/[^\u0000-\u007E]/g," ").replace("  "," "))},isActive:function(){return(this.get("active"))==="TRUE"?true:false}});b.Years=Backbone.Collection.extend({model:b.Year,initialize:function(){this.sort_key="year"},byYear:function(q){var p=this.filter(function(r){return r.get("year")===q});return new b.Years(p)},byYears:function(q){var p=this.filter(function(r){return($.inArray(r.get("year").toString(),q)>-1)});return new b.Years(p)},comparator:function(q,p){q=q.get(this.sort_key);p=p.get(this.sort_key);return q<p?1:q>p?-1:0},getLast:function(){this.active().sort();return this.first().get("year")},getFirst:function(){this.active().sort();return this.last().get("year")},active:function(){var p=this.filter(function(q){return q.isActive()});return new b.Years(p)}});b.Type=Backbone.Model.extend({});b.Types=Backbone.Collection.extend({model:b.Type,initialize:function(){this.sort_key="title";this.sort_dir="asc"},byRecords:function(p){var q=this.filter(function(r){return(p.hasType(r.get("id")))});return new b.Types(q)},comparator:function(q,p){var r=this.sort_dir==="asc"?1:-1;q=q.get(this.sort_key).toLowerCase();p=p.get(this.sort_key).toLowerCase();return r*((q>p)?1:(q<p)?-1:0)},sortBy:function(p,q){q=typeof q!=="undefined"?q:"asc";this.sort_key=p;this.sort_dir=q;return this.sort()}});b.Size=Backbone.Model.extend({});b.Sizes=Backbone.Collection.extend({model:b.Size,bySize:function(p){var q=this.filter(function(r){return(Math.ceil(p)>=r.get("min")&&Math.ceil(p)<=r.get("max"))});return new b.Sizes(q)},byRecords:function(p){var q=this.filter(function(r){return(p.hasSize(r.get("min")))});return new b.Sizes(q)}});b.Criterion=Backbone.Model.extend({initialize:function(){this.set("id",this.get("id").replace("_",""))}});b.Criteria=Backbone.Collection.extend({model:b.Criterion,getMax:function(){return this.length},byGroup:function(q){var p=this.filter(function(r){return r.get("criteriongroupid")===q});return new b.Criteria(p)}});b.CriteriaGroup=Backbone.Model.extend({initialize:function(){this.count_criteria()},count_criteria:function(){var q=0;var p=this;e.Criteria.each(function(r){if(r.get("criteriongroupid")===p.get("id")){q++}});this.count=q}});b.CriteriaGroups=Backbone.Collection.extend({model:b.CriteriaGroup});b.Record=Backbone.Model.extend({initialize:function(){this.set("typeid",this.get("typeid").trim());this.set("summaryoverview",this.get("summaryoverview").toString().replace(/[^\u0000-\u007E]/g," ").replace("  "," "));if(this.get("summaryoverview")==="0"){this.set("summaryoverview","")}if(this.get("staffno")===""){this.set("staffno",0)}if(this.get("type")===""){this.set("type","NS")}},isActive:function(p){p=typeof p!=="undefined"?p:true;return(this.get("active"))==="TRUE"?true:!p},getScore:function(r){r=typeof r!=="undefined"?r:false;var q=0;var p=this;e.Criteria.each(function(s){q+=p.getCriterionScore(s.id)});if(r){return Math.round((q/e.Criteria.getMax())*100)}else{return q}},getCriterionScore:function(p){return($.isNumeric(this.get(p)))?this.get(p):0},getGroupScore:function(p,t){t=typeof t!=="undefined"?t:false;var s=0;var r=0;var q=this;e.Criteria.each(function(u){if(u.get("criteriongroupid")===p){s+=q.getCriterionScore(u.id);r++}});if(t){return Math.round((s/r)*100)}else{return s}},getRank:function(){return e.Records.byScore(this.get("year"),this.getScore()).length+1},getScoreChange:function(r,q){r=typeof r!=="undefined"?r:false;q=typeof q!=="undefined"?q:this.get("year")-1;var p=e.Records.byEntity(this.get("entityid")).byYear(q).models[0];if(typeof p!=="undefined"){return this.getScore(r)-p.getScore(r)}else{return false}},getRankChange:function(q){q=typeof q!=="undefined"?q:this.get("year")-1;var p=e.Records.byEntity(this.get("entityid")).byYear(q).models[0];if(typeof p!=="undefined"){return -1*(this.getRank()-p.getRank())}else{return false}},getStaffNo:function(){return this.get("staffno")},getTypeTitle:function(){return e.Types.findWhere({id:this.get("typeid")}).get("title")},getStaffTitle:function(){return(this.get("staffno")>0)?this.get("staffno"):"Not specified"},getStaffCatTitle:function(){return e.Sizes.bySize(this.get("staffno")).first().get("title")},getSummary:function(){return(this.get("summaryoverview")!=="")?this.get("summaryoverview"):e.Years.byYear(this.get("year")).models[0].get("summaryoverview")}});b.Records=Backbone.Collection.extend({model:b.Record,initialize:function(){this.sort_key="title";this.sort_dir="asc"},comparator:function(q,p){var r=this.sort_dir==="asc"?1:-1;if(this.sort_key==="score"){q=q.getScore();p=p.getScore();return r*((q>p)?1:(q<p)?-1:0)}else{if(this.sort_key==="year"){q=q.get(this.sort_key);p=p.get(this.sort_key);return r*((q>p)?1:(q<p)?-1:0)}else{q=q.get(this.sort_key).toLowerCase();p=p.get(this.sort_key).toLowerCase();return r*((q>p)?1:(q<p)?-1:0)}}},sortBy:function(p,q){q=typeof q!=="undefined"?q:"asc";this.sort_key=p;this.sort_dir=q;return this.sort()},active:function(){var p=this.filter(function(q){return q.isActive()});return new b.Records(p)},byYear:function(r,q){q=typeof q!=="undefined"?q:true;var p=this.filter(function(s){return s.isActive(q)&&s.get("year")===r});return new b.Records(p)},byEntity:function(p,r){r=typeof r!=="undefined"?r:true;var q=this.filter(function(s){return s.isActive(r)&&s.get("entityid").toString()===p.toString()});return new b.Records(q)},byType:function(r,q){q=typeof q!=="undefined"?q:true;var p=this.filter(function(s){return s.isActive(q)&&s.get("typeid")===r});return new b.Records(p)},hasType:function(p){return typeof this.findWhere({typeid:p})!=="undefined"},hasSize:function(p){return this.bySize(p).length>0},bySize:function(p,r){r=typeof r!=="undefined"?r:true;var q=this.filter(function(t){var u=0;var s=0;e.Sizes.each(function(v){if(Math.ceil(p)>=v.get("min")&&Math.ceil(p)<=v.get("max")){u=v.get("min");s=v.get("max")}});return t.isActive(r)&&Math.ceil(t.getStaffNo())>=u&&Math.ceil(t.getStaffNo())<=s});return new b.Records(q)},byScore:function(t,r,p,s){p=typeof p!=="undefined"?p:0;s=typeof s!=="undefined"?s:true;var q=this.filter(function(u){if(p!==0){return u.isActive(s)&&u.getScore()>r&&u.getScore()<=p&&u.get("year")===t}else{return u.isActive(s)&&u.getScore()>r&&u.get("year")===t}});return new b.Records(q)},getResults:function(p){var t={criterion:"all",group:"all"};var s=$.extend({},t,p);var q={};var r;if(s.criterion!=="all"){r=1}else{if(s.group!=="all"){r=e.CriteriaGroups.where({id:s.group})[0].count}else{r=e.Criteria.length}}this.sortBy("year").each(function(u){if(u.isActive()){var v=u.get("year");if(v in q){if(s.criterion!=="all"){q[v].score+=u.getCriterionScore(s.criterion)}else{if(s.group!=="all"){q[v].score+=u.getGroupScore(s.group)}else{q[v].score+=u.getScore()}}q[v].count++}else{q[v]={};q[v].year=v;if(s.criterion!=="all"){q[v].score=u.getCriterionScore(s.criterion)}else{if(s.group!=="all"){q[v].score=u.getGroupScore(s.group)}else{q[v].score=u.getScore()}}q[v].count=1}q[v].percentage=Math.round(((q[v].score/q[v].count)/r)*100)}});return q}});b.Intro=Backbone.Model.extend({initialize:function(){this.minYear=e.Years.getFirst();this.maxYear=e.Years.getLast();this.title="Crown Entities and the Good Employer";this.subtitle="Annual Report Review "+this.minYear+" to "+this.maxYear;this.summary=$("#loading .summary p").html()}});o.Intro=Backbone.View.extend({initialize:function(){this.render()},render:function(){this.$el.html(this.template(this.model));return this},template:_.template('<div class="row">\n<div class="col-left">\n<h1 id="intro-title"><%= title %></h1>\n<h2><%= subtitle %></h2>\n<div class="summary"><p><%= summary %></p></div>\n</div>\n<div class="col-right">\n<a class="home-link" href="#" title="Reset Application: Crown Entities and the Good Employer"></a>\n</div>\n</div>'),renderPdf:function(p){console.log("intro.renderpdf");p.addText(this.model.title,"intro_title");p.addText(this.model.subtitle,"intro_subtitle");p.addText(this.model.summary,"intro_summary");p.addLine("intro_line");p.addImage("intro_logo","intro_logo")}});o.Tools=Backbone.View.extend({initialize:function(){this.render();this.listenTo(this.model,"change",this.render)},render:function(){var p=e.Records.byYear(parseInt(this.model.get("year")));var q=e.Years.active();if(this.model.get("report")==="entity"){q=q.byYears(Object.keys(e.Records.byEntity(this.model.get("id")).getResults()))}else{if(this.model.get("report")==="size"){q=q.byYears(Object.keys(e.Records.bySize(this.model.get("id")).getResults()))}else{if(this.model.get("report")==="type"){q=q.byYears(Object.keys(e.Records.byType(this.model.get("id")).getResults()))}}}var r={entities:p.models,types:e.Types.byRecords(p).sort().models,sizes:e.Sizes.byRecords(p).models,years:q.models,allActive:(this.model.get("report")==="all")?"active":"",entityActiveID:(this.model.get("report")==="entity")?this.model.get("id"):"",typeActiveID:(this.model.get("report")==="type")?this.model.get("id"):"",sizeActiveMin:(this.model.get("report")==="size")?this.model.get("id"):-1,yearActive:parseInt(this.model.get("year"))};this.$el.html(this.template($.extend(r,{select_width:178})));this.$("select#entity").select2({placeholder:"Entity",allowClear:true});this.$("select#type").select2({placeholder:"Type",allowClear:true,minimumResultsForSearch:99});this.$("select#size").select2({placeholder:"Size",allowClear:true,minimumResultsForSearch:99});this.$("select#year").select2({minimumResultsForSearch:99});this.initFullscreen();return this},events:{"click #all":"selectAll","click #renderPdf":"renderPdf","change #entity":"selectEntity","change #type":"selectType","change #size":"selectSize","change #year":"selectYear"},selectAll:function(p){p.preventDefault();e.App.navigate(this.model.get("year")+"/report/all-entities",{trigger:true})},selectEntity:function(p){p.preventDefault();if(this.$("#entity").val()!==""){e.App.navigate(this.model.get("year")+"/report/entity-"+this.$("#entity").val(),{trigger:true})}else{e.App.navigate(this.model.get("year")+"/report/all-entities",{trigger:true})}},selectType:function(p){p.preventDefault();if(this.$("#type").val()!==""){e.App.navigate(this.model.get("year")+"/report/type-"+this.$("#type").val(),{trigger:true})}else{e.App.navigate(this.model.get("year")+"/report/all-entities",{trigger:true})}},selectSize:function(p){p.preventDefault();if(this.$("#size").val()!==""){e.App.navigate(this.model.get("year")+"/report/size-"+this.$("#size").val(),{trigger:true})}else{e.App.navigate(this.model.get("year")+"/report/all-entities",{trigger:true})}},selectYear:function(p){p.preventDefault();e.App.navigate(this.$("#year").val()+"/report/"+this.model.get("report")+"-"+this.model.get("id"),{trigger:true})},renderPdf:function(p){p.preventDefault();_gaq.push(["_trackEvent","PDF-Report",this.model.get("year")+"-"+this.model.get("report")+"-"+this.model.get("id"),this.model.get("year")+"-"+this.model.get("report")+"-"+this.model.get("id")]);this.model.renderPdf()},template:_.template('<div class="row">\n  <h3 id="tools-title" class="medium pull-left">Select a report for a specific entity or a group of entities</h3>\n  <div aria-hidden="true" role="presentation">\n    <a href="#" class="fullscreen hidden-fullscreen hidden-standalone pull-right" data-toggle="fullscreen">Enter fullscreen <span class="icon-fullscreen-open"></span></a>    <a href="#" class="fullscreen visible-fullscreen hidden-standalone pull-right" data-toggle="fullscreen-close">Exit fullscreen <span class="icon-fullscreen-close"></span></a>\n  </div>\n</div>\n<div class="row" id="report-select"><button role="button" id="all" class="btn <%= allActive %>" aria-pressed="<%if (allActive === "active") { %>true<% } else { %>false<% } %>" >All entities</button><select id="entity" class="select2" style="width:<%=select_width%>px;">  <option></option>  <% var group_label = "A"; %>\n  <optgroup label="<%=group_label%>">\n  <%_.forEach(entities, function (entity) {%>\n    <% if (entity.get("title").charAt(0).toUpperCase() !== group_label) { %>\n    <% group_label = entity.get("title").charAt(0).toUpperCase();  %>\n    </optgroup><optgroup label="<%=group_label%>">\n    <% }  %>\n    <option value="<%= entity.get("entityid") %>" <% if (entity.get("entityid").toString() === entityActiveID.toString()) { print ("selected") } %> >    <%= entity.get("title") %></option>  <%})%>  </optgroup>\n</select><select id="type" class="select2" style="width:<%=select_width%>px;">  <option></option>  <% _.forEach(types, function (type) {%>    <option value="<%= type.get("id") %>" <% if (type.get("id") === typeActiveID) { print ("selected") } %> >    <%= type.get("title") %></option>  <%})%></select><select id="size" class="select2" style="width:<%=select_width%>px;">  <option></option>  <% _.forEach(sizes, function (size) {%>    <option value="<%= size.get("min") %>" <% if (size.get("min") <= sizeActiveMin && size.get("max") >= sizeActiveMin) { print ("selected") } %> >    <%= size.get("title") %></option>  <%})%></select><select id="year" class="select2">  <% _.forEach(years, function (year) {%>    <option value="<%= year.get("year") %>" <% if (parseInt(year.get("year")) === yearActive) { print ("selected") } %>>    <%= year.get("year") %></option>  <%})%></select></div><!--[if gt IE 8]><!-->\n<div aria-labelledby="renderPdf" class="row"><a title="Download a pdf-version of the current report" href="#" id="renderPdf" class="pull-right">Download a pdf-version of selected report <span class="icon-download"></span></a></div><!--<![endif]-->\n'),initFullscreen:function(){if(top!==self){$("body").removeClass("standalone");var r=fullScreenApi.isFullScreen(),p;$(window).on("resize",function(){clearTimeout(p);p=setTimeout(q,300)});function q(){if(r!==fullScreenApi.isFullScreen()){if(r){$("body").removeClass("fullscreen")}else{$("body").addClass("fullscreen")}r=fullScreenApi.isFullScreen()}if(top===self){$("body").addClass("standalone")}}$("a[data-toggle='fullscreen']").attr("href",i);$("a[data-toggle='fullscreen']").click(function(t){var s=/webkit/.test(navigator.userAgent.toLowerCase());if(top!==self&&fullScreenApi.supportsFullScreen&&!s){t.preventDefault();$("html").requestFullScreen()}});$("a[data-toggle='fullscreen-close']").click(function(s){if(top!==self&&fullScreenApi.supportsFullScreen){s.preventDefault();$("html").cancelFullScreen()}})}}});b.Overview=Backbone.Model.extend({initialize:function(){this.set("updated",0);this.set("resultsAll",e.Records.getResults());this.resetFields()},update:function(){this.currentYear=parseInt(e.Control.get("year"));this.currentYearData=e.Years.byYear(this.currentYear).first();this.currentCount=this.get("resultsAll")[this.currentYear].count;this.set({year:this.currentYear,graphCollectionActive:null,graphCollection:e.Records.byYear(this.currentYear).sortBy("title","desc").sortBy("score","asc")});this.resetFields();if(e.Control.get("report")==="all"){this.set({title:"All entities",subtitle:"This report provides an overview of the compliance of all Crown entities",score:this.get("resultsAll")[this.currentYear].percentage,score_label:"Average compliance",rank_label:"Total number of Crown entities",rank:this.currentCount,summary:this.currentYearData.get("summaryoverview"),modelAverages:new b.Averages({}),modelAveragesTime:new b.AveragesTime({all:this.get("resultsAll")})});if(typeof this.get("resultsAll")[this.currentYear-1]!=="undefined"){var A=this.get("resultsAll")[this.currentYear].percentage-this.get("resultsAll")[this.currentYear-1].percentage;this.set("score_change",A);this.set("score_change_class",A>0?"up":A<0?"down":"same")}}else{if(e.Control.get("report")==="entity"){var B=e.Control.get("id");var q=e.Records.byEntity(B);var y=q.byYear(this.currentYear);if(y.length===0){}else{this.set("graphCollectionActive",y);var t=this.get("graphCollectionActive").first();var w=e.Records.byType(t.get("typeid")).getResults();var C=e.Records.bySize(t.getStaffNo()).getResults();var z="";var v="";if(t.getScoreChange(true)!==false){z=t.getScoreChange(true);v=z>0?"up":z<0?"down":"same"}var E="";var s="";if(t.getRankChange()!==false){E=t.getRankChange();s=E>0?"up":E<0?"down":"same"}this.set({modelAverages:new b.Averages({all:this.get("resultsAll")[this.currentYear].percentage,type:w[this.currentYear].percentage,size:C[this.currentYear].percentage}),modelAveragesTime:new b.AveragesTime({all:this.get("resultsAll"),type:w,size:C,entity:q.getResults(),type_label:"Same type: "+t.getTypeTitle(),size_label:"Same size: "+t.getStaffCatTitle(),entity_label:"Entity: "+t.get("title")})});this.set({title:t.get("title"),subtitle:t.get("explanation"),type_label:"Type",type:t.getTypeTitle(),type_id:t.get("typeid"),size_label:"Size",size:t.getStaffCatTitle(),size_id:t.getStaffNo(),score:t.getScore(true),score_change:z,score_change_class:v,rank_label:"Rank",rank:t.getRank(),rank_of:" of "+this.currentCount+" entities",rank_change:E,rank_change_class:s,summary:t.getSummary()})}}else{if(e.Control.get("report")==="type"||e.Control.get("report")==="size"){var x,p,r;if(e.Control.get("report")==="type"){var u=e.Control.get("id");x=e.Types.findWhere({id:u});p=e.Records.byType(u);r=p.getResults();this.set({title:"Category: "+x.get("title"),modelAverages:new b.Averages({all:this.get("resultsAll")[this.currentYear].percentage}),modelAveragesTime:new b.AveragesTime({all:this.get("resultsAll"),type:r,type_label:x.get("title")})})}else{if(e.Control.get("report")==="size"){var D=e.Control.get("id");x=e.Sizes.bySize(D).first();p=e.Records.bySize(D);r=p.getResults();this.set({title:"Category: "+x.get("title"),modelAverages:new b.Averages({all:this.get("resultsAll")[this.currentYear].percentage}),modelAveragesTime:new b.AveragesTime({all:this.get("resultsAll"),size:r,size_label:(x.get("title"))})})}}this.set({graphCollectionActive:p.byYear(this.currentYear),subtitle:"This report provides an overview of the compliance of selected category",score_label:"Average compliance",score:r[this.currentYear].percentage,rank_label:"Number of entities in category",rank:p.byYear(this.currentYear).length,rank_of:" of "+this.currentCount+" entities total",rank_change:"",summary:this.currentYearData.get("summaryoverview")});if(typeof r[this.currentYear-1]!=="undefined"){var A=r[this.currentYear].percentage-r[this.currentYear-1].percentage;this.set("score_change",A);this.set("score_change_class",A>0?"up":A<0?"down":"same")}}}}this.set("report",e.Control.get("report"));this.set("updated",e.Control.get("report")+e.Control.get("id")+e.Control.get("year"))},resetFields:function(){this.set({title:"",subtitle:"",type_label:"",type:"",size_label:"",size:"",score_label:"Overall compliance",score:"",score_change:"",score_change_class:"",rank_label:"",rank:"",rank_of:"",rank_change:"",rank_change_class:"",summary:""})}});o.Overview=Backbone.View.extend({initialize:function(){this.subviews={};this.render();this.listenTo(this.model,"change:updated",this.render)},events:{"click .accordion-toggle":"accordionToggle","click .load-report":"loadReport"},loadTitle:function(p){p.preventDefault();e.App.navigate(e.Control.get("year")+"/report/"+$(p.currentTarget).data("report"),+"-",+$(p.currentTarget).data("reportid"),{trigger:true})},accordionToggle:function(p){p.preventDefault();if(this.$(".accordion").hasClass("open")){this.accordionClose()}else{e.Control.accordionCloseAll();this.accordionOpen()}},accordionOpen:function(){var p=this;this.$(".accordion-bottom").slideDown(function(){p.$(".accordion").addClass("open");p.$(".accordion-top").attr("aria-expanded",true);p.$(".accordion-top").attr("aria-selected",true);p.$(".accordion-bottom").attr("aria-expanded",true);p.$(".accordion-bottom").attr("aria-hidden",false);p.$("button.accordion-open").attr("aria-hidden",true);p.$("button.accordion-false").attr("aria-hidden",false)})},accordionClose:function(){var p=this;this.$(".accordion-bottom").slideUp(function(){p.$(".accordion").removeClass("open");p.$(".accordion-top").attr("aria-expanded",false);p.$(".accordion-top").attr("aria-selected",false);p.$(".accordion-bottom").attr("aria-expanded",false);p.$(".accordion-bottom").attr("aria-hidden",true);p.$("button.accordion-open").attr("aria-hidden",false);p.$("button.accordion-false").attr("aria-hidden",true)})},render:function(){this.$el.html(this.template(this.model.attributes));this.subviews.graphView=new o.OverviewGraph({collection:this.model.get("graphCollection"),collectionActive:this.model.get("graphCollectionActive"),axis_label:"Compliance",average_line:this.model.get("score")});this.$("#overview-graph").append(this.subviews.graphView.render().el);this.subviews.graphView.renderGraph();this.subviews.averagesView=new o.Averages({model:this.model.get("modelAverages")});this.$(".averages-panel").append(this.subviews.averagesView.render().el);this.subviews.averagesGraphView=new o.AveragesTimeGraph({model:this.model.get("modelAveragesTime"),marker:false});this.$("#overview-time-graph").append(this.subviews.averagesGraphView.render().el);this.subviews.averagesGraphView.renderGraph();return this},template:_.template('<div id="overview-title" class="row" >\n  <div class="col-left">\n    <h2 id="overview-the-title" aria-label="Current report: Name of selected entity or entity group" ><%= title %></h2>\n    <% if (subtitle !== "") { %>\n    <h3 aria-label="Additional information" class="medium"><%= subtitle %></h3>\n    <% } %>\n</div>\n<div class="col-right">\n<div aria-label="Year for current report" class="year active"><%= year %></div>\n</div>\n</div><!-- #overview-title -->\n<div id="overview-cat" class="row">\n<% if (type !== "") {%>\n  <div>\n    <span class="label"><%= type_label %> </span>\n    <span><a class="load-report" data-report="type" data-reportid="<%= type_id %>" href="#<%= year %>/report/type-<%= type_id %>" title="Load Report: <%= type %>"><%= type %></a></span>\n  </div>\n<% } %>\n<% if (size !== "") {%>\n  <div>\n    <span class="label"><%= size_label %> </span>\n    <span><a class="load-report" data-report="size" data-reportid="<%= size_id %>" href="#<%= year %>/report/size-<%= size_id %>" title="Load Report: <%= size %>"><%= size %></a></span>\n  </div>\n<% } %>\n</div><!-- #overview-cat -->\n<div id="overview-graph"></div><!-- #overview-graph -->\n<div id="overview-bottom" role="tablist">\n  <div class="accordion open" >\n    <div class="accordion-top row" role="tab" aria-expanded="true" aria-selected="true">\n      <a href="#" aria-hidden="true" role="button" class="accordion-open accordion-toggle icon-accordion-toggle" title="Show more" aria-label="Show more"></a>\n      <a href="#" aria-hidden="false" role="button" class="accordion-close accordion-toggle icon-accordion-toggle" title="Show less" aria-label="Show less"></a>\n      <div class="col-left">\n        <div class="score-panel">\n          <div class="score-label"><%= score_label %></div>\n          <div class="score active"><%= score %>%</div>\n          <% if (score_change !== "") {%>\n            <div class="score-change active" aria-label="Change of score compared with last year"><div class="icon-trend <%= score_change_class %>"></div>\n            <% if (score_change > 0) {%>+<%}%><%= score_change %>%\n            </div>\n          <%}%>\n        </div>\n      </div>\n      <div class="col-right">\n        <div class="averages-panel"></div>\n      </div>\n    </div>\n    <div class="accordion-bottom row" role="tabpanel" aria-expanded="true" aria-hidden="false">\n      <div class="col-left">\n        <div class="rank-panel">\n          <div class="rank-label"><%= rank_label %></div>\n          <div class="rank active"><span class="the-rank"><%= rank %></span><span class="rank-of"><%= rank_of %></span></div>\n          <% if (rank_change !== "") {%>\n            <div class="rank-change active" aria-label="Change of score compared with last year"><div class="icon-trend <%= rank_change_class %>"></div>\n              <% if (rank_change > 0) {%>+<%}%><%= rank_change %>\n            </div>\n          <%}%>\n          </div>\n        <div class="summary-panel">\n          <p><%= summary %></p>\n        </div>\n      </div>\n      <div class="col-right">\n        <div id="overview-time-graph"></div><!-- #overview-time-graph -->\n      </div>\n    </div>\n  </div>\n</div><!-- #overview-bottom -->    '),renderPdf:function(s){var q=e.Control.color();console.log("overview.renderpdf");var u=0;var t=0;s.addText(this.model.get("year").toString(),"overview_year",{color:q});u+=s.addText(this.model.get("title"),"overview_title");u+=s.addText(this.model.get("subtitle"),"overview_subtitle",{offy:u});if(this.model.get("report")==="entity"){s.addText(this.model.get("type_label"),"overview_type_label",{offy:u});s.addText(this.model.get("type"),"overview_type",{offy:u});s.addText(this.model.get("size_label"),"overview_size_label",{offy:u});s.addText(this.model.get("size"),"overview_size",{offy:u})}s.addText(this.model.get("score_label"),"overview_score_label");s.addText(this.model.get("score").toString()+"%","overview_score",{color:q});var p=this.model.get("score_change");if(p!==""){if(p<0){p=p.toString()+"%";s.addImage("overview_"+this.model.get("report")+"_down","overview_score_trend")}else{if(p>0){p="+"+p.toString()+"%";s.addImage("overview_"+this.model.get("report")+"_up","overview_score_trend")}else{if(p===0){p=p.toString()+"%";s.addImage("overview_"+this.model.get("report")+"_same","overview_score_trend")}}}}s.addText(p,"overview_score_change",{color:q});s.addLine("overview_score_line");s.addText(this.model.get("rank_label"),"overview_rank_label");s.addText(this.model.get("rank").toString(),"overview_rank",{color:q});if(this.model.get("rank")<10){t=-5}s.addText(this.model.get("rank_of"),"overview_rank_of",{color:q,offx:t});var r=this.model.get("rank_change");if(r!==""){if(r<0){r=r.toString();s.addImage("overview_"+this.model.get("report")+"_down","overview_rank_trend")}else{if(r>0){r="+"+r.toString();s.addImage("overview_"+this.model.get("report")+"_up","overview_rank_trend")}else{if(r>0){r=r.toString();s.addImage("overview_"+this.model.get("report")+"_same","overview_rank_trend")}}}}s.addText(r,"overview_rank_change",{color:q});s.addLine("overview_rank_line");this.subviews.graphView.renderPdf(s);this.subviews.averagesGraphView.renderPdf(s,"averages_graph");if(this.model.get("modelAverages").get("all")>-1){this.subviews.averagesView.renderPdf(s,"overview_averages");s.addText(this.model.get("summary"),"overview_summary")}else{s.addText(this.model.get("summary"),"overview_summary",{offy:-15})}}});o.OverviewGraph=Backbone.View.extend({initialize:function(p){this.options=p||{};this.currentIndex=-99;this.ticks=[[0,"0%"],[25,"25%"],[50,"50%"],[75,"75%"],[100,"100%"]]},events:{"plotclick .overview-plot":"plotclick","plothover .overview-plot":"plothover"},attributes:{"class":"overview-graph row"},plotOptions:{yaxis:{tickColor:g(l.dark),color:g(l.dark),min:0,max:100,position:"right",tickLength:5,font:{color:g(l.dark),size:13}},xaxis:{tickColor:g(l.dark),show:false},legend:{show:false},grid:{hoverable:true,clickable:true,autoHighlight:true,backgroundColor:"#ffffff",show:true,aboveData:false,margin:0,labelMargin:10,markings:[],borderWidth:{top:0,right:1,bottom:1,left:0},borderColor:g(l.dark),color:g(l.dark),minBorderMargin:0,axisMargin:0},series:{shadowSize:0,bars:{show:true,fill:1,barWidth:1,align:"center",lineWidth:1}}},render:function(){this.$el.html(this.template({axis_label:this.options.axis_label}));return this},renderGraph:function(){var y=_.clone(this.plotOptions);y.yaxis.ticks=this.ticks;var t=[];var s=[];var w=[];var r=[];var q=[];y.colors=[];y.colors.push("#ffffff");y.colors.push(e.Control.color(true,true));y.colors.push("#ffffff");y.colors.push(e.Control.color(false,true));y.xaxis.min=-1.5;y.xaxis.max=this.collection.length+1.5;var x=this.$(".overview-plot-table table tbody");x.append('<tr><th scope="col">Entity</th><th scope="col">Compliance in %</th></tr>');for(var u=0;u<this.collection.length;u++){var v=this.collection.models[u];if(v.getScore(true)===0){w.push([u,v.getScore(true)])}t.push([u,v.getScore(true)]);if(this.options.collectionActive!==null){var p=this.options.collectionActive.findWhere({entityid:v.get("entityid")});if(typeof p!=="undefined"){if(v.getScore(true)===0){r.push([u,v.getScore(true)])}q.push([u,p.getScore(true)]);x.append("<tr><td>Entity (active): "+v.get("title")+"</td><td>"+v.getScore(true)+"%</td></tr>")}else{q.push([u,null])}}else{x.append("<tr><td>Entity (other): "+v.get("title")+"</td><td>"+v.getScore(true)+"%</td></tr>")}}s.push({data:t,bars:{fillColor:e.Control.color(true,true)},highlightColor:g(l.all)});s.push({data:w,points:{show:true},bars:{show:false},highlightColor:g(l.all)});s.push({data:q,bars:{fillColor:e.Control.color(false,true)},highlightColor:g(l.all)});s.push({data:r,points:{show:true},bars:{show:false},highlightColor:g(l.all)});if(e.Control.get("report")!=="entity"){s.push({data:[[-1,this.options.average_line],[this.collection.length,this.options.average_line]],lines:{show:true,lineWidth:1},bars:{show:false}});if(e.Control.get("report")==="all"){y.colors.push(g(l.all))}else{if(e.Control.get("report")==="type"){y.colors.push(g(l.type))}else{if(e.Control.get("report")==="size"){y.colors.push(g(l.size))}}}}this.plot=$.plot(this.$(".overview-plot"),s,y)},renderPdf:function(r){r.addPlot(this.plot.getCanvas(),"overview_graph");r.addText(this.options.axis_label,"overview_graph_axis_label");var q=r.item("overview_graph");for(var p=0;p<this.ticks.length;p++){r.addText(this.ticks[this.ticks.length-1-p][1],"overview_graph_ticks",{offy:q.h*0.92/(this.ticks.length-1)*p})}},plotclick:function(q,r,p){console.log("plotclick");q.preventDefault();if(p){e.App.navigate(e.Control.get("year")+"/report/entity-"+this.collection.models[p.dataIndex].get("entityid"),{trigger:true})}},plothover:function(s,v,r){var p,t;if(this.hoverTip){this.hoverTip.remove()}if(r){document.body.style.cursor="pointer";var u=r.dataIndex/this.collection.length;var q=this.collection.models[r.dataIndex];this.hoverTip=$(this.toolTipHTML(r.series.data[r.dataIndex],q,(u*100)));this.$(".overview-plot").parent().append(this.hoverTip);p=this.hoverTip.outerHeight();t=this.hoverTip.outerWidth();if(this.collection.models[r.dataIndex].getScore()===0){this.hoverTip.offset({left:r.pageX-t*u,top:r.pageY-p-15})}else{this.hoverTip.offset({left:r.pageX-t*u,top:r.pageY-p-5})}}else{document.body.style.cursor="default"}},toolTipHTML:function(r,q,s){var p="";p+='<div class="tooltip tooltip-overview">';p+='<div class="tooltip-inner-wrap">';if(q){p+='<div class="series"><strong>'+q.get("title")+"</strong></div>"}p+='<div class="stats">Compliance: '+r[1]+"%</div>";p+='<div class="stats">Rank: '+q.getRank()+"</div>";p+="</div>";p+="</div>";p+="</div>";p+="<style>.tooltip:after {left:"+s+"%;}</style>";return p},template:_.template('<div class="plot-wrapper">\n<div aria-hidden="true" role="presentation" class="yaxis-label"><%= axis_label %></div>\n<div aria-label="Compliance of all entities - Chart. Details in the following table" role="img" class="overview-plot"></div>\n<div class="overview-plot-table sr-only">\n<summary>Compliance of all entities - Table</summary>\n<table>\n<caption>Compliance of all entities, active entities highlighted</caption>\n<tbody>\n</tbody>\n</table>\n</div>\n</div>')});b.Details=Backbone.Model.extend({initialize:function(){this.set("updated",0);this.results={};this.results.all=e.Records.getResults();this.results.all_geref=e.Records.getResults({criterion:"geref"});this.results.all_ge=e.Records.getResults({group:"GE"});this.results.all_wp=e.Records.getResults({group:"WP"});this.results.all_eeoref=e.Records.getResults({criterion:"eeoref"});this.results.all_review=e.Records.getResults({criterion:"review"});this.results.all_participation=e.Records.getResults({criterion:"participation"});this.resetFields()},update:function(){this.currentYear=parseInt(e.Control.get("year"));this.currentYearData=e.Years.byYear(this.currentYear).first();this.currentCount=this.results.all[this.currentYear].count;this.resetFields();var s={geref:{},ge:{},eeoref:{},review:{},wp:{},participation:{}};var u,t;var v=this;if(e.Control.get("report")==="entity"){var x=e.Control.get("id");var p=e.Records.byEntity(x);var w=p.byYear(this.currentYear);if(w.length===0){}else{var q=w.first();t=e.Records.byType(q.get("typeid"));u=e.Records.bySize(q.getStaffNo());s.geref.entity=p.getResults({criterion:"geref"});s.ge.entity=p.getResults({group:"GE"});s.ge.entity_elements=[];_.each(e.Criteria.byGroup("GE").models,function(z){s.ge.entity_elements.push({id:z.get("id"),title:z.get("title"),results:w.getResults({criterion:z.get("id")})})});s.wp.entity=p.getResults({group:"WP"});s.wp.entity_elements=[];_.each(e.Criteria.byGroup("WP").models,function(z){s.wp.entity_elements.push({id:z.get("id"),title:z.get("title"),results:w.getResults({criterion:z.get("id")})})});s.eeoref.entity=p.getResults({criterion:"eeoref"});s.review.entity=p.getResults({criterion:"review"});s.participation.entity=p.getResults({criterion:"participation"})}}else{if(e.Control.get("report")==="type"){var r=e.Control.get("id");t=e.Records.byType(r)}else{if(e.Control.get("report")==="size"){var y=e.Control.get("id");u=e.Records.bySize(y)}}}s.geref.all=this.results.all_geref;s.ge.all=this.results.all_ge;s.ge.all_elements=[];_.each(e.Criteria.byGroup("GE").models,function(z){s.ge.all_elements.push({id:z.get("id"),title:z.get("title"),results:e.Records.byYear(v.currentYear).getResults({criterion:z.get("id")})})});s.wp.all=this.results.all_wp;s.wp.all_elements=[];_.each(e.Criteria.byGroup("WP").models,function(z){s.wp.all_elements.push({id:z.get("id"),title:z.get("title"),results:e.Records.byYear(v.currentYear).getResults({criterion:z.get("id")})})});s.eeoref.all=this.results.all_eeoref;s.review.all=this.results.all_review;s.participation.all=this.results.all_participation;if(typeof t!=="undefined"){s.geref.type=t.getResults({criterion:"geref"});s.ge.type=t.getResults({group:"GE"});s.ge.type_elements=[];_.each(e.Criteria.byGroup("GE").models,function(z){s.ge.type_elements.push({id:z.get("id"),title:z.get("title"),results:t.byYear(v.currentYear).getResults({criterion:z.get("id")})})});s.wp.type=t.getResults({group:"WP"});s.wp.type_elements=[];_.each(e.Criteria.byGroup("WP").models,function(z){s.wp.type_elements.push({id:z.get("id"),title:z.get("title"),results:t.byYear(v.currentYear).getResults({criterion:z.get("id")})})});s.eeoref.type=t.getResults({criterion:"eeoref"});s.review.type=t.getResults({criterion:"review"});s.participation.type=t.getResults({criterion:"participation"})}if(typeof u!=="undefined"){s.geref.size=u.getResults({criterion:"geref"});s.ge.size=u.getResults({group:"GE"});s.ge.size_elements=[];_.each(e.Criteria.byGroup("GE").models,function(z){s.ge.size_elements.push({id:z.get("id"),title:z.get("title"),results:u.byYear(v.currentYear).getResults({criterion:z.get("id")})})});s.wp.size=u.getResults({group:"WP"});s.wp.size_elements=[];_.each(e.Criteria.byGroup("WP").models,function(z){s.wp.size_elements.push({id:z.get("id"),title:z.get("title"),results:u.byYear(v.currentYear).getResults({criterion:z.get("id")})})});s.eeoref.size=u.getResults({criterion:"eeoref"});s.review.size=u.getResults({criterion:"review"});s.participation.size=u.getResults({criterion:"participation"})}this.set({year:this.currentYear,subview_models:{geref:new b.CriteriaDetails({criteria:"single",year:this.currentYear,id:"geref",report:e.Control.get("report"),results:s.geref,title:e.Criteria.findWhere({id:"geref"}).get("title").trim(),summary:this.currentYearData.get("summarygeref")}),ge:new b.CriteriaDetails({criteria:"group",year:this.currentYear,id:"ge",report:e.Control.get("report"),results:s.ge,title:e.CriteriaGroups.findWhere({id:"GE"}).get("title").trim(),summary:this.currentYearData.get("summarygeelements")}),eeoref:new b.CriteriaDetails({criteria:"single",year:this.currentYear,id:"eeoref",report:e.Control.get("report"),results:s.eeoref,title:e.Criteria.findWhere({id:"eeoref"}).get("title").trim(),summary:this.currentYearData.get("summaryeeoref")}),review:new b.CriteriaDetails({criteria:"single",year:this.currentYear,id:"review",report:e.Control.get("report"),results:s.review,title:e.Criteria.findWhere({id:"review"}).get("title").trim(),summary:this.currentYearData.get("summaryreview")}),wp:new b.CriteriaDetails({criteria:"group",year:this.currentYear,id:"wp",report:e.Control.get("report"),results:s.wp,title:e.CriteriaGroups.findWhere({id:"WP"}).get("title").trim(),summary:this.currentYearData.get("summarywp")}),participation:new b.CriteriaDetails({criteria:"single",year:this.currentYear,id:"participation",report:e.Control.get("report"),results:s.participation,title:e.Criteria.findWhere({id:"participation"}).get("title").trim(),summary:this.currentYearData.get("summaryparticipation")})}});this.set("updated",e.Control.get("id")+e.Control.get("year"))},resetFields:function(){this.set({subview_models:{}})}});o.Details=Backbone.View.extend({initialize:function(){this.subviews=[];this.render();this.listenTo(this.model,"change:updated",this.render)},render:function(){this.subviews=[];this.$el.html(this.template());var p=this;_.each(this.model.get("subview_models"),function(r){var q=new o.Criterion({model:r});p.subviews.push(q);p.$("#criteria-details-list").append(q.render().el)});_.each(this.subviews,function(q){q.renderGraphs();q.accordionClose(0)});return this},renderPdf:function(u,q){var s=[u.item("detail1"),u.item("detail2")];var p=[];_.each(this.subviews,function(v){var w=u.defaults.offsets.criteria[v.model.get("id")];var x={x:s[w.p-1].x+w.x,y:s[w.p-1].y+w.y};if(typeof p[w.p-1]==="undefined"){p[w.p-1]=[]}p[w.p-1].push({subview:v,pos:x})});for(var r=0;r<p.length;r++){var t=p[r];_.each(t,function(v){v.subview.renderPdf(u,v.pos)});if(r<p.length-1){u.addPage()}}return this},template:_.template('<div id="criteria-details-list" role="tablist"></div>')});b.CriteriaDetails=Backbone.Model.extend({initialize:function(){var q=this.get("results");var p=this.get("year");if(this.get("report")==="all"){this.set("score",q.all[p].percentage);if(this.get("criteria")==="group"){this.set("all_group_elements",q.all_elements)}this.set("modelAverages",new b.Averages({}));this.set("modelAveragesTime",new b.AveragesTime({all:q.all,legend:false,criterion:this.get("title")}))}else{if(this.get("report")==="entity"){if(this.get("criteria")==="group"){this.set("score",q.entity[p].percentage);this.set("entity_group_elements",q.entity_elements);this.set("all_group_elements",q.all_elements);this.set("type_group_elements",q.type_elements);this.set("size_group_elements",q.size_elements)}else{this.set("score",Math.round(q.entity[p].percentage/100)*100)}this.set("modelAverages",new b.Averages({all:q.all[p].percentage,type:q.type[p].percentage,size:q.size[p].percentage}));this.set("modelAveragesTime",new b.AveragesTime({all:q.all,type:q.type,size:q.size,entity:q.entity,legend:false,criterion:this.get("title")}))}else{if(this.get("report")==="type"){this.set("score",q.type[p].percentage);if(this.get("criteria")==="group"){this.set("all_group_elements",q.all_elements);this.set("type_group_elements",q.type_elements)}this.set("modelAverages",new b.Averages({all:q.all[p].percentage}));this.set("modelAveragesTime",new b.AveragesTime({all:q.all,type:q.type,legend:false,criterion:this.get("title")}))}else{if(this.get("report")==="size"){this.set("score",q.size[p].percentage);if(this.get("criteria")==="group"){this.set("all_group_elements",q.all_elements);this.set("size_group_elements",q.size_elements)}this.set("modelAverages",new b.Averages({all:q.all[p].percentage}));this.set("modelAveragesTime",new b.AveragesTime({all:q.all,size:q.size,legend:false,criterion:this.get("title")}))}}}}}});o.Criterion=Backbone.View.extend({initialize:function(){this.subviews={}},events:{"click .accordion-toggle":"accordionToggle"},accordionToggle:function(p){p.preventDefault();if(this.$(".accordion").hasClass("open")){this.accordionClose()}else{e.Control.accordionCloseAll();this.accordionOpen()}},accordionOpen:function(){var p=this;this.$(".accordion-bottom").slideDown(function(){p.$(".accordion").addClass("open");p.$(".accordion-top").attr("aria-expanded",true);p.$(".accordion-top").attr("aria-selected",true);p.$(".accordion-bottom").attr("aria-expanded",true);p.$(".accordion-bottom").attr("aria-hidden",false);p.$("button.accordion-open").attr("aria-hidden",true);p.$("button.accordion-false").attr("aria-hidden",false)})},accordionClose:function(q){q=typeof q!=="undefined"?q:400;var p=this;this.$(".accordion-bottom").slideUp(q,function(){p.$(".accordion").removeClass("open");p.$(".accordion-top").attr("aria-expanded",false);p.$(".accordion-top").attr("aria-selected",false);p.$(".accordion-bottom").attr("aria-expanded",false);p.$(".accordion-bottom").attr("aria-hidden",true);p.$("button.accordion-open").attr("aria-hidden",false);p.$("button.accordion-false").attr("aria-hidden",true)})},render:function(){this.$el.html(this.template(this.model.attributes));var r=this;var p=true;if(this.model.get("criteria")==="group"){var q=0;_.each(this.model.attributes.all_group_elements,function(s){if(r.model.get("report")==="all"){r.$(".group-elements").append(r.template_elements_all($.extend(s,{year:r.model.attributes.year})))}else{if(r.model.get("report")==="entity"){r.$(".group-elements").append(r.template_elements_entity($.extend(r.model.attributes,{index:q})))}else{if(r.model.get("report")==="type"){r.$(".group-elements").append(r.template_elements_type($.extend(r.model.attributes,{index:q})))}else{if(r.model.get("report")==="size"){r.$(".group-elements").append(r.template_elements_size($.extend(r.model.attributes,{index:q})))}}}}q++});p=false}this.subviews.averagesView=new o.Averages({model:this.model.get("modelAverages")});this.$(".averages-panel").append(this.subviews.averagesView.render().el);this.subviews.averagesGraphView=new o.AveragesTimeGraph({model:this.model.get("modelAveragesTime"),marker:p});this.$(".criteria-time-graph").append(this.subviews.averagesGraphView.render().el);return this},renderGraphs:function(){this.subviews.averagesGraphView.renderGraph()},renderPdf:function(u,p){u.addLine("half_line",$.extend(p,{color:l.dark}));u.addCriteriaTitle(this.model.get("title"),this.model.get("score"),this.model.get("report"),this.model.get("criteria"),p);if(this.model.get("criteria")==="single"){if(this.model.get("modelAverages").get("all")>-1){this.subviews.averagesView.renderPdf(u,"averages",{x:p.x,y:p.y+u.defaults.offsets.averages.single});u.addText(this.model.get("summary"),"half",{x:p.x,y:p.y+u.defaults.offsets.summary.single})}else{u.addText(this.model.get("summary"),"half",{x:p.x,y:p.y+u.defaults.offsets.summary.single-15})}}else{if(this.model.get("criteria")==="group"){var s=this;var r=0;var t=[];if(this.model.get("report")==="all"){t=this.model.get("all_group_elements")}else{if(this.model.get("report")==="entity"){t=this.model.get("entity_group_elements")}else{if(this.model.get("report")==="type"){t=this.model.get("type_group_elements")}else{if(this.model.get("report")==="size"){t=this.model.get("size_group_elements")}}}}var v=20;for(var r=0;r<t.length;r++){var q=t[r];u.addGroupCriteria(q.title,q.results[s.model.attributes.year].percentage,this.model.get("report"),{x:p.x,y:p.y+v});v+=6}u.addLine("half_line",{x:p.x,y:p.y+u.defaults.offsets.averages.group-3});if(this.model.get("modelAverages").get("all")>-1){this.subviews.averagesView.renderPdf(u,"averages",{x:p.x,y:p.y+u.defaults.offsets.averages.group});u.addText(this.model.get("summary"),"half",{x:p.x,y:p.y+u.defaults.offsets.summary.group})}else{u.addText(this.model.get("summary"),"half",{x:p.x,y:p.y+u.defaults.offsets.summary.group-15})}}}},template:_.template('  <div class="criteria row">\n    <div class="accordion">\n      <div class="accordion-top row" role="tab" aria-expanded="false" aria-selected="false">\n        <a href="#" aria-hidden="true" role="button" class="accordion-open accordion-toggle icon-accordion-toggle" title="Show more" aria-label="Show more"></a>\n        <a href="#" aria-hidden="false" role="button" class="accordion-close accordion-toggle icon-accordion-toggle" title="Show less" aria-label="Show less"></a>\n        <div class="col-left">\n          <h2 class="title-score-wrap">\n          <div class="title-score" >\n            <% if (report === "entity" && score === 100 && criteria === "single") { %>\n              <span class="icon-score-pass" aria-label="Entity compliant for criteria"></span><span class="the-score active sr-only"><%= score %>%</span>\n            <% } else if (report === "entity" && score === 0 && criteria === "single") { %>\n              <span class="icon-score-fail" aria-label="Entity not compliant for criteria"></span><span class="the-score active sr-only"><%= score %>%</span>\n            <% } else { %>\n              <% if (score === 0) { %> \n                <span class="icon-score-inverse" aria-label="Compliance for criteria"></span><span class="the-score active"><%= score %>%</span>\n              <% } else { %>\n                <span class="icon-score" aria-label="Compliance for criteria"></span><span class="the-score"><%= score %>%</span>\n              <% } %>\n            <% } %>\n          </div>\n          <div class="title"><a href="#" class="accordion-toggle" title="Show or hide details"><%= title %></a></div>\n        </h2><!-- .title-score-wrap -->\n        </div><!-- .col-left -->\n        <div class="col-right">\n          <div class="averages-panel"></div>\n        </div><!-- .col-right -->\n      </div><!-- .accordion-top -->\n      <div class="accordion-bottom row" role="tabpanel" aria-expanded="true" aria-hidden="false">\n        <% if (criteria === "group") { %><div class="group-elements"></div><% } %>\n        <div class="col-left">\n          <div class="summary-panel"><%= summary %></div>\n        </div><!-- .col-left -->\n        <div class="col-right">\n          <div class="criteria-time-graph"></div><!-- .criteria-time-graph -->\n        </div><!-- .col-right -->\n      </div><!-- .accordion-bottom -->\n    </div><!-- .accordion-->\n  </div><!-- .criteria -->\n'),template_elements_all:_.template('<div class="item row">\n<div class="col-1"><span class="score-all active"><%= results[year].percentage %>%</span></div>\n<div class="col-2"><span class="title"><%= title %></span></div>\n</div>\n'),template_elements_entity:_.template('<div class="item row">\n<div class="col-1">\n<% if (entity_group_elements[index].results[year].percentage >= 50 ) { %>\n<span class="score-entity"><span class="icon-score-pass-small"></span></span>\n<% } else if (entity_group_elements[index].results[year].percentage < 50 ) { %>\n<span class="score"><span class="icon-score-fail-small"></span></span>\n<% } %>\n</div>\n<div class="col-2"><span class="title"><%= entity_group_elements[index].title %></span></div>\n<div class="col-3"><span class="score-type"><%= type_group_elements[index].results[year].percentage %>%</span></div>\n<div class="col-4"><span class="score-size"><%= size_group_elements[index].results[year].percentage %>%</span></div>\n<div class="col-5"><span class="score-all"><%= all_group_elements[index].results[year].percentage %>%</span></div>\n</div>'),template_elements_type:_.template('<div class="item row">\n<div class="col-1"><span class="score-type active"><%= type_group_elements[index].results[year].percentage %>%</span></div>\n<div class="col-2"><span class="title"><%= type_group_elements[index].title %></span></div>\n<div class="col-3"><span class="score-all"><%= all_group_elements[index].results[year].percentage %>%</span></div>\n</div>'),template_elements_size:_.template('<div class="item row">\n<div class="col-1"><span class="score-size active"><%= size_group_elements[index].results[year].percentage %>%</span></div>\n<div class="col-2"><span class="title"><%= size_group_elements[index].title %></span></div>\n<div class="col-3"><span class="score-all"><%= all_group_elements[index].results[year].percentage %>%</span></div>\n</div>')});b.Averages=Backbone.Model.extend({defaults:{title:"Average compliance of",all:-1,type:-1,size:-1,all_label:"All entities",type_label:"Same type",size_label:"Same size",all_color:g(l.all),type_color:g(l.type),size_color:g(l.size)}});o.Averages=Backbone.View.extend({initialize:function(p){this.options=p||{}},render:function(){if(this.model.get("all")>-1||this.model.get("type")>-1||this.model.get("size")>-1){this.$el.html(this.template(this.model.attributes))}return this},renderPdf:function(t,r,p){var u={x:0,y:0};var q={top:2,right:16};u.y+=t.addText(this.model.get("title"),r,p);u.y+=1;var s=t.item(r,p);if(this.model.get("type")>-1){t.addText(this.model.get("type_label"),"default",{x:s.x+u.x,y:s.y+u.y+q.top});t.addText(this.model.get("type")+"%","default",{x:s.x+u.x+q.right,y:s.y+u.y+q.top,style:"bold",color:l.type});u.x+=t.addAverageBar(this.model.get("type"),{x:s.x+u.x,y:s.y+u.y,color:l.type})}if(this.model.get("size")>-1){t.addText(this.model.get("size_label"),"default",{x:s.x+u.x,y:s.y+u.y+q.top});t.addText(this.model.get("size")+"%","default",{x:s.x+u.x+q.right,y:s.y+u.y+q.top,style:"bold",color:l.size});u.x+=t.addAverageBar(this.model.get("size"),{x:s.x+u.x,y:s.y+u.y,color:l.size})}if(this.model.get("all")>-1){t.addText(this.model.get("all_label"),"default",{x:s.x+u.x,y:s.y+u.y+q.top});t.addText(this.model.get("all")+"%","default",{x:s.x+u.x+q.right,y:s.y+u.y+q.top,style:"bold",color:l.all});u.x+=t.addAverageBar(this.model.get("all"),{x:s.x+u.x,y:s.y+u.y,color:l.all})}u.y+=9;t.addLine("half_line",{x:s.x,y:s.y+u.y})},template:_.template('    <div class="averages">\n      <div class="averages-title"><%=title%></div>\n      <ul class="averages-list">\n      <% if (type > -1) {%>\n      <li>\n        <div class="average-type averages-full"><span class="averages-score" style="width:<%=type%>%;background:<%=type_color%>;"></span></div>\n        <div><%=type_label%> <%=type%>%</div>\n      </li><% }%>\n      <% if (size > -1) {%>\n      <li>\n        <div class="average-size averages-full"><span class="averages-score" style="width:<%=size%>%;background:<%=size_color%>;"></span></div>\n        <div><%=size_label%> <%=size%>%</div>\n      </li><% }%>\n      <% if (all > -1) {%>\n      <li>\n        <div class="average-all averages-full"><span class="averages-score" style="width:<%=all%>%;background:<%=all_color%>;"></span></div>\n        <div><%=all_label%> <%=all%>%</div>\n      </li><% }%>\n    </div>\n    ')});b.AveragesTime=Backbone.Model.extend({defaults:{title:"Compliance over time",criterion:"Overall compliance",all:{},type:{},size:{},entity:{},all_label:"All entities",type_label:"Same type",size_label:"Same size",entity_label:"Current entity",legend:true,axis_label:"Compliance"}});o.AveragesTimeGraph=Backbone.View.extend({initialize:function(p){this.options=p||{};this.ticks=[[0,"0%"],[50,"50%"],[100,"100%"]];this.axis_padding=0.05},attributes:{"class":"time-graph"},events:{"plothover .time-plot":"plothover","plotclick .time-plot":"plotclick"},plotOptions:{yaxis:{tickColor:g(l.dark),color:g(l.dark),min:0,max:100,position:"right",tickLength:5,font:{color:g(l.dark),size:13},autoscaleMargin:0},xaxis:{color:g(l.dark),tickSize:1,tickDecimals:0,tickLength:0,font:{color:g(l.dark),size:13,weight:"bold"},autoscaleMargin:0},legend:{show:false},grid:{hoverable:true,clickable:true,autoHighlight:true,backgroundColor:"#ffffff",show:true,aboveData:false,margin:0,labelMargin:10,markings:[],borderWidth:{top:0,right:1,bottom:1,left:0},borderColor:g(l.dark),color:g(l.dark),minBorderMargin:0,axisMargin:0},series:{shadowSize:0}},render:function(){this.$el.html(this.template($.extend(this.model.attributes,{cid:this.cid})));return this},lineOptions:function(p,r){var s=1.7;var q=2.5;if(p==="all"){if(e.Control.get("report")==="all"){return $.extend(r,{lines:{show:true,lineWidth:q},points:{show:true}})}else{return $.extend(r,{dashes:{show:true,lineWidth:s,dashLength:2}})}}else{if(p==="type"){if(e.Control.get("report")==="type"){return $.extend(r,{lines:{show:true,lineWidth:q},points:{show:true}})}else{return $.extend(r,{dashes:{show:true,lineWidth:s,dashLength:5}})}}else{if(p==="size"){if(e.Control.get("report")==="size"){return $.extend(r,{lines:{show:true,lineWidth:q},points:{show:true}})}else{return $.extend(r,{dashes:{show:true,lineWidth:s,dashLength:8}})}}else{if(p==="entity"){return $.extend(r,{lines:{show:true,lineWidth:q},points:{show:true}})}}}}},renderGraph:function(){var q=_.clone(this.plotOptions);q.yaxis.ticks=this.ticks;var t=[];var u=[];q.colors=[];var s=this.$(".time-plot-table table tbody");s.append('<tr><td></td><th scope="col">Year></th><th scope="col">Compliance in %</th></tr>');var p=Object.keys(this.model.get("all"));q.xaxis.max=Math.max.apply(Math,p)+((p.length-1)*this.axis_padding);q.xaxis.min=Math.min.apply(Math,p)-((p.length-1)*this.axis_padding);var r=this;_.each(this.model.get("all"),function(v){t.push([v.year,v.percentage]);s.append("<tr><td>"+r.model.get("all_label")+"</td><td>"+v.year+"</td><td>"+v.percentage+"%</td></tr>")});u.push(this.lineOptions("all",{data:t}));q.colors.push(g(l.all));t=[];if(!$.isEmptyObject(this.model.get("type"))){_.each(this.model.get("type"),function(v){t.push([v.year,v.percentage]);s.append("<tr><td>"+r.model.get("type_label")+"</td><td>"+v.year+"</td><td>"+v.percentage+"%</td></tr>")});u.push(this.lineOptions("type",{data:t}));q.colors.push(g(l.type))}t=[];if(!$.isEmptyObject(this.model.get("size"))){_.each(this.model.get("size"),function(v){t.push([v.year,v.percentage]);s.append("<tr><td>"+r.model.get("size_label")+"</td><td>"+v.year+"</td><td>"+v.percentage+"%</td></tr>")});u.push(this.lineOptions("size",{data:t}));q.colors.push(g(l.size))}t=[];if(!$.isEmptyObject(this.model.get("entity"))){_.each(this.model.get("entity"),function(v){t.push([v.year,v.percentage]);s.append("<tr><td>"+r.model.get("entity_label")+"</td><td>"+v.year+"</td><td>"+v.percentage+"%</td></tr>")});u.push(this.lineOptions("entity",{data:t}));q.colors.push(g(l.entity))}this.plot=$.plot(this.$(".time-plot"),u,q);if(this.model.get("legend")){$(".plot-wrapper-"+this.cid+" .legend").html(this.template_legend($.extend(this.model.attributes,{report:e.Control.get("report")})))}},plotclick:function(q,r,p){q.preventDefault();if(p){e.App.navigate(p.datapoint[0]+"/report/"+e.Control.get("report")+"-"+e.Control.get("id"),{trigger:true})}},plothover:function(r,t,q){var p,s;if(this.hoverTip){this.hoverTip.remove()}if(q){document.body.style.cursor="pointer";this.hoverTip=$(this.toolTipHTML(q.datapoint));this.$(".time-plot").parent().append(this.hoverTip);p=this.hoverTip.outerHeight();s=this.hoverTip.outerWidth();this.hoverTip.offset({left:q.pageX-s/2,top:q.pageY-p-15})}else{document.body.style.cursor="default"}},toolTipHTML:function(q){var p="";p+='<div class="tooltip tooltip-time">';p+='<div class="tooltip-inner-wrap">';p+='<div class="stats">Year: '+q[0]+"</div>";p+='<div class="stats">Compliance: '+q[1]+"%</div>";p+="</div>";p+="</div>";return p},renderPdf:function(p,x,w){p.addPlot(this.plot.getCanvas(),x,w);p.addText(this.model.get("axis_label"),x+"_axis_label");p.addText(this.model.get("title"),x+"_title");var u=p.item(x);for(var s=0;s<this.ticks.length;s++){p.addText(this.ticks[this.ticks.length-1-s][1],x+"_ticks",{offy:u.h*0.79/(this.ticks.length-1)*s})}var y=Object.keys(this.model.get("all"));for(var s=0;s<y.length;s++){var v=(u.w*0.85*(1-2*this.axis_padding)/(y.length-1)*s)+u.w*0.85*this.axis_padding;p.addText(y[s],x+"_xticks",{offx:v})}var u=p.item(x+"_legend");var q=this.model.attributes;var r=e.Control.get("report");var t=0;var v=8;if(!$.isEmptyObject(q.entity)){p.addLine(x+"_legend_line",{color:l.entity,offy:t});p.addText(q.entity_label,x+"_legend",{offx:v});t+=4}if(!$.isEmptyObject(q.type)){if(r==="type"){p.addLine(x+"_legend_line",{color:l.type,offy:t})}else{p.addLine(x+"_legend_line",{color:l.type,offy:t,dash:0.66})}p.addText(q.type_label,x+"_legend",{offx:v,offy:t});t+=4}if(!$.isEmptyObject(q.size)){if(r==="size"){p.addLine(x+"_legend_line",{color:l.size,offy:t})}else{p.addLine(x+"_legend_line",{color:l.size,offy:t,dash:1})}p.addText(q.size_label,x+"_legend",{offx:v,offy:t});t+=4}if(r==="all"){p.addLine(x+"_legend_line",{color:l.all,offy:t})}else{p.addLine(x+"_legend_line",{color:l.all,offy:t,dash:0.33})}p.addText(q.all_label,x+"_legend",{offx:v,offy:t})},template:_.template('<div class="plot-wrapper plot-wrapper-<%= cid %>">\n<div class="averages-title"><%= title %></div>\n<div aria-hidden="true" role="presentation" class="yaxis-label"><%= axis_label %></div>\n<div class="time-plot" aria-label="<%= title %> for <%= criterion %> - Chart. Details in the following table" role="img" ></div>\n<div aria-hidden="true" role="presentation" class="legend"></div>\n<div class="time-plot-table sr-only">\n<summary><%= title %> for <%= criterion %> - Table</summary>\n<table>\n<caption><%= title %> for <%= criterion %> </caption>\n<tbody>\n</tbody>\n</table>\n</div>\n</div>'),template_legend:_.template('    <ul class="legend-list"><% if (!$.isEmptyObject(entity)){%><li class="legend-entity <% if (report === "entity"){%>legend-main<% } %>">\n<span class="line"></span>\n<span class="legend-label"><%=entity_label%></span>\n</li><% }%><% if (!$.isEmptyObject(type)){%><li class="legend-type <% if (report === "type"){%>legend-main<% } %>">\n<span class="line"></span>\n<span class="legend-label"><%=type_label%></span>\n</li><% }%><% if (!$.isEmptyObject(size)){%><li class="legend-size <% if (report === "size"){%>legend-main<% } %>">\n<span class="line"></span>\n<span class="legend-label"><%=size_label%></span>\n</li><% }%><li class="legend-all <% if (report === "all"){%>legend-main<% } %>">\n<span class="line"></span>\n<span class="legend-label"><%=all_label%></span>\n</li>    </ul>    ')});b.Footer=Backbone.Model.extend({initialize:function(){this.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],this.set({hrc_url_title:"To explore all good employer reports visit:",hrc_url_anchor:"www.hrc.co.nz/eeo",published:"Last updated: "+e.Control.get("updated").getDate()+". "+this.monthNames[e.Control.get("updated").getMonth()]+" "+e.Control.get("updated").getFullYear(),isbn:"ISBN: "+h,copyright:"&#0169; "+e.Control.get("updated").getFullYear()+" New Zealand Human Rights Commission",hrc_url:"http://www.hrc.co.nz/eeo",builtby_url:"http://dumpark.com",builtby:"a data visualisation by dumpark"})}});o.Footer=Backbone.View.extend({initialize:function(){this.render()},render:function(){this.$el.html(this.template(this.model.attributes))},renderPdf:function(p){p.addImage("footer","footer_image");p.addText(this.model.get("hrc_url_title"),"footer_url_title");p.addText(this.model.get("hrc_url_anchor"),"footer_url");p.addText(this.model.get("published"),"footer_published");p.addText(this.model.get("isbn"),"footer_isbn");p.addLine("footer_line1");p.addLine("footer_line2")},template:_.template('<div class="footer-scene">\n  <div class="col-left">\n    <div class="footer-wrap-left">\n      <div class="footer-hrcurl-title"><%= hrc_url_title %></div>\n      <div class="footer-hrcurl"><a href="<%= hrc_url %>" target="_blank" title="<%= hrc_url_title %> <%= hrc_url_anchor %>"><%= hrc_url_anchor %></a></div>\n    </div>\n  </div>\n  <div class="col-right">\n    <div class="footer-wrap-right">\n      <div class="footer-published"><%= published %></div>\n      <div class="footer-copyright"><%= copyright %></div>\n    </div>\n  </div>\n</div>\n<div class="footer-builtby pull-right"><a href="<%= builtby_url %>" target="_blank" title="<%= builtby %>"><%= builtby %></a></div>\n    ')});b.DocWriter=Backbone.Model.extend({initialize:function(){this.doc=new jsPDF({lineHeight:this.defaults.lineHeight});this.doc.setFontSize(this.defaults.elements.def.size)},defaults:{lineHeight:1.4,offsets:{averages:{single:23,group:70},detail_title:{x:15,y:11},summary:{single:42,group:89},criteria:{geref:{p:1,y:0,x:0},eeoref:{p:1,y:0,x:95},ge:{p:2,y:0,x:0},wp:{p:2,y:0,x:95},review:{p:2,y:130,x:0},participation:{p:2,y:130,x:95}}},elements:{def:{y:15,x:15,w:180,h:0,size:8,style:"normal",margin:{top:0,bottom:2,right:0,left:0},color:l.dark,offy:0,offx:0},half:{y:15,x:15,w:85,h:0,size:8,style:"normal",margin:{top:0,bottom:2,right:0,left:0},color:l.dark},intro_title:{y:15,size:17,style:"bold"},intro_subtitle:{y:24,size:10,style:"bold"},intro_summary:{y:32,w:138},intro_logo:{y:13,x:163,w:32,h:35},intro_line:{y:60,h:0.75,color:l.dark},overview_title:{y:71,w:130,size:16,yalign:"center"},overview_subtitle:{y:70,w:130,color:l.medium},overview_year:{y:63,x:169,size:27,style:"bold"},overview_type_label:{y:71,x:15,style:"bold"},overview_type:{y:71,x:23},overview_size_label:{y:75,x:15,style:"bold"},overview_size:{y:75,x:23},overview_score_label:{y:96,size:10,style:"bold"},overview_score:{y:99,size:40,style:"bold"},overview_score_trend:{y:104,x:53,w:7,h:7},overview_score_change:{y:111,x:53},overview_score_line:{y:117,w:44,h:0.75,color:l.light},overview_rank_label:{y:124,style:"bold",w:44,yalign:"center"},overview_rank:{y:126,size:23,style:"bold"},overview_rank_of:{y:131,x:25},overview_rank_trend:{y:124,x:53,w:7,h:7},overview_rank_change:{y:131,x:54},overview_rank_line:{y:138,w:44,h:0.75,color:l.light},overview_graph:{y:100,x:63,w:132,h:39.3},overview_graph_axis_label:{y:96,x:180,size:7},overview_graph_ticks:{y:103,x:188,yalign:"center"},averages_graph:{y:149,x:107,w:89,h:34},averages_graph_title:{y:144,x:110,style:"bold"},averages_graph_axis_label:{y:145,x:180,size:7},averages_graph_ticks:{y:152,x:188,yalign:"center"},averages_graph_xticks:{y:179,x:107,style:"bold"},averages_graph_legend:{y:186,x:110,size:7},averages_graph_legend_line:{y:187.6,x:110,w:5,h:1},overview_averages:{y:142.5,w:85,style:"bold"},averages:{w:85,style:"bold"},overview_summary:{y:162,w:85},average_line:{w:22,h:4,margin:{right:6},color:l.light},half_line:{w:85,h:0.75,color:l.light},detail1:{y:208},detail2:{y:15},detail_title:{style:"bold",w:65,size:11},detail_image:{w:12,h:12},detail_image_small:{w:3,h:3},detail_score:{style:"bold",size:11,color:l.white},footer_image:{y:222,w:180,color:l.white},footer_url_title:{y:270,x:20,w:75,size:7,color:l.white},footer_url:{y:273,x:20,w:75,size:10,color:l.white},footer_published:{y:255,x:103,w:56,size:7,color:l.white},footer_isbn:{y:259,x:103,w:56,size:7,color:l.white},footer_c:{y:274,x:103,w:56,size:7,style:"bold",color:l.white},footer_line1:{y:255,x:100,w:1,h:22,color:l.white},footer_line2:{y:255,x:162,w:1,h:22,color:l.white},page_no:{y:279.3,x:199,size:7}}},item:function(q,p){p=typeof p!=="undefined"?p:{};var r=$.extend({},this.defaults.elements[q]);var s=$.extend({},this.defaults.elements.def);r=$.extend(r,p);return $.extend(s,r)},convert2pt:function(p){return p*this.doc.internal.scaleFactor},convert2mm:function(p){return p/this.doc.internal.scaleFactor},output:function(){var p="HRC-Good-Employer_";if(e.Control.get("report")==="all"){p+="All-Entities"}else{if(e.Control.get("report")==="type"){p+="Type-"+e.Control.get("id")}else{if(e.Control.get("report")==="size"){p+="Size-"+e.Control.get("id")}else{if(e.Control.get("report")==="entity"){p+=e.Records.byYear(parseInt(e.Control.get("year"))).byEntity(e.Control.get("id")).first().get("title").replace(/\s/g,"-")}}}}this.doc.save(p+"_"+e.Control.get("year")+".pdf")},addText:function(t,r,v){if(t===""){return 0}r=typeof r!=="undefined"?r:"def";var u=this.item(r,v);var q=(u.yalign!=="undefined")?u.yalign:"top";this.doc.setFontSize(u.size);this.doc.setFontStyle(u.style);this.doc.setTextColor(u.color.r,u.color.g,u.color.b);t=t.toString().replace(/[\u0101]/g,"a");var p=this.doc.splitTextToSize(t,this.convert2pt(u.w/1.3));var w=p.length*this.convert2mm(u.size)*this.defaults.lineHeight+u.margin.bottom;if(q==="center"){w=w/2;u.y-=w}this.doc.text(u.x+u.offx,u.y+u.offy+this.convert2mm(u.size),p);return w},addLine:function(p,u){var t=this.item(p,u);var v="h";if(t.h>t.w){var s=t.h;t.h=t.w;t.w=s;v="v"}this.doc.setLineWidth(this.convert2mm(t.h));this.doc.setDrawColor(t.color.r,t.color.g,t.color.b);if(typeof t.dash!=="undefined"){var q=0;for(var r=0;r<Math.floor(t.w/(t.dash));r++){if(r%2===0){this.doc.line(t.x+q,t.y+t.offy,t.x+t.dash+q,t.y+t.offy)}q+=t.dash}}else{if(v==="h"){this.doc.line(t.x,t.y+t.offy,t.x+t.w,t.y+t.offy)}else{this.doc.line(t.x,t.y+t.offy,t.x,t.y+t.offy+t.w)}}},addImage:function(q,r,p,t){p=typeof p!=="undefined"?p:{};t=typeof t!=="undefined"?t:{};var s=this.item(r,t);var u=this.get("images")[q];u=$.extend(u,p);this.doc.addImage(u.data,u.format,s.x,s.y,s.w,s.h)},addPlot:function(r,w,s){var y=this.item(w,s);var p=2;var v=r.width*p;var t=r.height*p;var u=document.createElement("canvas");u.width=v;u.height=t;var x=u.getContext("2d");x.fillStyle="#FFFFFF";x.fillRect(0,0,v,t);x.drawImage(r,0,0,v,t);var q=u.toDataURL("image/jpeg");this.doc.addImage(q,"JPEG",y.x,y.y,y.w,y.h)},addAverageBar:function(r,q){this.addLine("average_line",{x:q.x,y:q.y});var p=this.item("average_line");this.addLine("average_line",{x:q.x,y:q.y,w:p.w*r/100,color:q.color});return p.w+p.margin.right},addCircle:function(p){this.doc.setFillColor(p.color.r,p.color.g,p.color.b);this.doc.circle(p.x,p.y,p.r,"F")},addTick:function(p){this.doc.setLineWidth(1.8);this.doc.setDrawColor(p.color.r,p.color.g,p.color.b);this.doc.line(p.x+3,p.y+5.69,p.x+5.62,p.y+8.31);this.doc.line(p.x+4.38,p.y+8.31,p.x+9,p.y+3.69)},addCross:function(p){this.doc.setLineWidth(1.8);this.doc.setDrawColor(p.color.r,p.color.g,p.color.b);this.doc.line(p.x+3.69,p.y+3.69,p.x+8.31,p.y+8.31);this.doc.line(p.x+3.69,p.y+8.31,p.x+8.31,p.y+3.69)},addCriteriaTitle:function(t,s,r,v,q){var p="details_"+r+"_";var u=2.2;if(s<10){u=3.2}else{if(s>99){u=1.2}}if(r==="entity"&&s===100&&v==="single"){this.addCircle({x:q.x+6,y:q.y+9.8,r:6,color:l[r]});this.addTick({x:q.x,y:q.y+4,color:l.white})}else{if(r==="entity"&&s===0&&v==="single"){this.addCircle({x:q.x+6,y:q.y+9.8,r:6,color:l.lighter});this.addCross({x:q.x,y:q.y+4,color:l.entity})}else{if(s===0){this.addCircle({x:q.x+6,y:q.y+9.8,r:6,color:l.lighter});this.addText(s+"%","detail_score",{color:l[r],x:q.x+u,y:q.y+this.defaults.offsets.detail_title.y,yalign:"center"})}else{this.addCircle({x:q.x+6,y:q.y+9.8,r:6,color:l[r]});this.addText(s+"%","detail_score",{x:q.x+u,y:q.y+this.defaults.offsets.detail_title.y,yalign:"center"})}}}this.addText(t,"detail_title",{x:q.x+this.defaults.offsets.detail_title.x,y:q.y+this.defaults.offsets.detail_title.y,yalign:"center"});this.addLine("half_line",{x:q.x,y:q.y+20})},addGroupCriteria:function(t,s,r,q){if(r==="entity"){var p="details_entity_";if(s>=50){p+="pass_small";this.addImage(p,"detail_image_small",{},{x:q.x+4.5,y:q.y+3})}else{if(s<50){p+="fail_small";this.addImage(p,"detail_image_small",{},{x:q.x+4.5,y:q.y+3})}}}else{var u=3;if(s<10){u=4}else{if(s>99){u=1.4}}this.addText(s+"%","def",{x:q.x+u,y:q.y+3,style:"bold"})}this.addText(t,"def",{x:q.x+10,y:q.y+3})},addPage:function(){this.doc.addPage()}});function n(p){$(".loading."+p).hide();$(".waiting."+p).removeClass("waiting").css("visibility","visible");$("#report").attr("aria-busy",false)}function a(q){var p=q.toString(16);return p.length===1?"0"+p:p}function g(p){return"#"+a(p.r)+a(p.g)+a(p.b)}if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}if(!Object.keys){Object.keys=(function(){var r=Object.prototype.hasOwnProperty,s=!({toString:null}).propertyIsEnumerable("toString"),q=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],p=q.length;return function(v){if(typeof v!=="object"&&(typeof v!=="function"||v===null)){throw new TypeError("Object.keys called on non-object")}var t=[],w,u;for(w in v){if(r.call(v,w)){t.push(w)}}if(s){for(u=0;u<p;u++){if(r.call(v,q[u])){t.push(q[u])}}}return t}}())}m.App=Backbone.Router.extend({routes:{"":"redirect","report/*filter":"redirect",":year":"year",":year/report/*filter":"report"},redirect:function(p){var q=e.Years.getLast();if(p){this.navigate(q.toString()+"/report/"+p,{trigger:true})}else{this.navigate(q.toString(),{trigger:true})}},year:function(p){if($.isNumeric(p)){this.navigate(p+"/report/all-entities",{trigger:true})}else{this.navigate("",{trigger:true})}},report:function(r,p){var q=p.split("-");if($.inArray(q[0],["all","entity","type","size"])===-1||q[1]==="none"||q[1]===""){this.navigate(r+"/report/all-entities",{trigger:true})}else{e.Control.set({year:r,report:q[0],id:q[1]});_gaq.push(["_trackEvent","Online-Report",r+"-"+q[0]+"-"+q[1],r+"-"+q[0]+"-"+q[1]]);$("#report").removeClass(function(s,t){return(t.match(/\breport-\S+/g)||[]).join(" ")});$("#report").addClass("report-"+q[0]).addClass("report-id-"+q[1]);e.Overview=e.Overview||new b.Overview();e.Details=e.Details||new b.Details();e.Footer=e.Footer||new b.Footer();e.Overview.update();e.Details.update();e.viewsIntro=e.viewsIntro||new o.Intro({el:$("#intro"),model:new b.Intro()});e.viewsTools=e.viewsTools||new o.Tools({el:$("#tools"),model:e.Control});e.viewsOverview=e.viewsOverview||new o.Overview({el:$("#overview"),model:e.Overview});e.viewsDetails=e.viewsDetails||new o.Details({el:$("#details"),model:e.Details});e.viewsFooter=e.viewsFooter||new o.Footer({el:$("#footer"),model:e.Footer})}}});function c(p){e.Control=new b.Control({updated:new Date(p.Years.updated)});e.Years=new b.Years(p.Years.elements);e.Types=new b.Types(p.Types.elements);e.Sizes=new b.Sizes(p.Sizes.elements);e.Criteria=new b.Criteria(p.Criteria.elements);e.CriteriaGroups=new b.CriteriaGroups(p.CriteriaGroups.elements);e.Records=new b.Records();e.Years.each(function(r){if(r.isActive()){var q=p[r.get("year")].elements;_.each(q,function(s){s.year=r.get("year")});e.Records.add(q)}})}function f(p){c(p);n("onData");e.App=new m.App();Backbone.history.start()}$(function(){if(typeof isdebug==="undefined"||isdebug===false){Tabletop.init({key:d,parseNumbers:true,callback:f,proxy:j})}else{Tabletop.init({key:d,parseNumbers:true,callback:f})}})});